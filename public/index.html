<!DOCTYPE html>
<html>
<head>
  <title>OPC Cricket Scoring</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding: 18px; background: #f4f7fc; color:#122; }
    .card { background: white; padding: 14px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); margin-bottom: 14px; }
    h1 { text-align: center; margin: 6px 0 14px 0; }
    select, input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
    }
    label { display: block; margin-top: 8px; font-weight: bold; font-size: 14px; }
    button { padding: 8px 12px; margin: 4px; background: #0c7bdc; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button.secondary { background:#eee; color:#222 }
    button.danger { background:#d9534f; }
    .inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:6px; border-bottom:1px solid #f0f0f0; font-size:13px }
    .small { font-size:12px; color:#666 }
    .log { background: #fff; padding: 10px; border-radius: 8px; height: 180px; overflow-y: auto; border: 1px solid #ddd; font-family: monospace; }
    .target-info { font-size: 14px; font-weight: bold; color: #0c7bdc; margin-top: 8px; }

    /* Popups */
    .overlay {
      display:none; position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.45);
      justify-content:center; align-items:center; z-index:999;
    }
    .popup {
      background:white; padding:16px; border-radius:10px;
      width:360px; box-shadow:0 8px 30px rgba(0,0,0,0.25);
    }
    .popup .row { display:flex; gap:8px; margin-top:8px; }
    .popup .row button { flex:1; }
    .warning { color: #a66; font-weight:700; margin-top:8px; }
  </style>
</head>
<body>
<h1>Orchid Park Cricket Scoring</h1>

<!-- NEXT BOWLER POPUP -->
<div id="bowlerPopup" class="overlay">
  <div class="popup">
    <h3>Select next bowler</h3>
    <label>Choose bowler:</label>
    <select id="nextBowlerSelect"></select>
    <div id="bowlerWarning" class="warning" style="display:none;"></div>
    <div class="row" style="margin-top:10px;">
      <button id="confirmNextBowlerBtn">Set Bowler & Resume</button>
      <button id="cancelBowlerBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- EXTRAS POPUP -->
<div id="extraPopup" class="overlay">
  <div class="popup">
    <h3>Extras</h3>
    <label id="extraLabel">Extra runs (besides +1):</label>
    <input id="extraRunsInput" type="number" min="0" value="0" />
    <div class="row" style="margin-top:10px;">
      <button id="submitExtraBtn">Submit</button>
      <button id="cancelExtraBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- WICKET TYPE POPUP -->
<div id="wicketTypePopup" class="overlay">
  <div class="popup">
    <h3>Wicket ‚Äî Choose type</h3>
    <label>Type:</label>
    <select id="wicketTypeSelect">
      <option value="Bowled">Bowled</option>
      <option value="Caught">Caught</option>
      <option value="LBW">LBW</option>
      <option value="Run Out">Run Out</option>
      <option value="Stumped">Stumped</option>
      <option value="Hit Wicket">Hit Wicket</option>
      <option value="Retired Hurt">Retired Hurt</option>
      <option value="Out of the Court">Out of the Court</option>
      <option value="Other">Other</option>
    </select>
    <div class="row" style="margin-top:10px;">
      <button id="confirmWicketTypeBtn">Confirm Wicket</button>
      <button id="cancelWicketTypeBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- WICKET ACTION POPUP -->
<div id="wicketPopup" class="overlay">
  <div class="popup">
    <h3>Wicket! Choose action</h3>
    <div class="row">
      <button id="openNewBatsmanBtn">Select New Batsman</button>
      <button id="activateLastManBtn">Last Man Standing</button>
    </div>
    <div class="row">
      <button id="closeWicketPopupBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- NEW BATSMAN POPUP -->
<div id="newBatsmanPopup" class="overlay">
  <div class="popup">
    <h3>Select New Batsman</h3>
    <select id="newBatsmanSelect"></select>
    <div class="row" style="margin-top:10px;">
      <button id="submitNewBatsmanBtn">Add</button>
      <button id="closeNewBatsmanBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- CHANGE STRIKER POPUP -->
<div class="overlay" id="changeStrikerPopup">
  <div class="popup">
    <h3>Change Striker</h3>

    <div class="row">
      <button id="swapStrikeBtn">Swap Striker & Non-Striker</button>
    </div>

    <label style="margin-top:8px;">Or set a specific player as striker:</label>
    <select id="setStrikerSelect"></select>

    <div class="row" style="margin-top:10px;">
      <button id="setStrikerBtn">Set Striker</button>
      <button id="cancelSetStrikerBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<!-- NEW: END INNINGS AFTER OVER POPUP -->
<div id="overEndPopup" class="overlay">
  <div class="popup">
    <h3>End innings?</h3>
    <p class="small">An over has just completed. Do you want to end the innings now?</p>
    <div class="row" style="margin-top:10px;">
      <button id="confirmEndInningsBtn" class="danger">End Innings</button>
      <button id="continueInningsBtn" style="background:#ddd;color:#222">Continue</button>
    </div>
  </div>
</div>

<!-- MATCH SETUP -->
<div class="card" id="matchSetupCard">
  <h3>üèè Match Setup</h3>
  <h4>1. Create Teams</h4>
  <div class="grid">
    <div><label>Team A Name:</label><input id="teamA_name" value="Mandai Monks"></div>
    <div><label>Team B Name:</label><input id="teamB_name" value="Seletar Sharks"></div>
  </div>
  <button id="createTeamsBtn" style="margin-top:10px;width:100%;">SAVE TEAMS</button>
  <hr style="margin:15px 0;" />
  <div id="inningsStartBlock" style="display:none;">
    <h4>2. Start Innings <span id="inningsStartHeader">1</span></h4>
    <label>Batting Team:</label>
    <select id="battingTeamSelect"><option value="teamA">Team A</option><option value="teamB">Team B</option></select>

    <div class="grid" style="margin-top:10px;">
      <div><label>Opening Striker:</label><select id="strikerSelect"></select></div>
      <div><label>Opening Non-Striker:</label><select id="nonStrikerSelect"></select></div>
    </div>

    <label style="margin-top:10px;">Opening Bowler:</label>
    <select id="startingBowlerSelect"></select>

    <div style="margin-top:10px;"><button id="startInningsBtn" style="width:100%;">START INNINGS</button></div>
  </div>
</div>

<!-- SCOREBOARD -->
<div class="card">
  <h3>üìä Scoreboard</h3>
  <div id="inningsInfo" style="font-size:16px;font-weight:700;color:#0c7bdc;">Innings 1</div>
  <div id="innings1Summary" class="small" style="margin-bottom:6px;"></div>
  <div id="teamNames" style="font-size:14px;color:#444;"></div>
  <div id="targetInfo" class="target-info"></div>
  <div id="score" style="font-size:36px;font-weight:700">0/0</div>
  <div id="overs" class="small">Overs: 0.0</div>
  <div style="margin-top:10px;">
    <button id="endInningsBtn" class="danger" style="display:none;">END 1ST INNINGS</button>
  </div>
</div>

<!-- SCORING CONTROLS -->
<div class="card">
  <h3>‚ñ∂Ô∏è Scoring Controls</h3>

  <div class="inline">
    <button class="runBtn" data-runs="0">0</button>
    <button class="runBtn" data-runs="1">1</button>
    <button class="runBtn" data-runs="2">2</button>
    <button class="runBtn" data-runs="3">3</button>
    <button class="runBtn" data-runs="4">4</button>
    <button class="runBtn" data-runs="5">5</button>
    <button class="runBtn" data-runs="6">6</button>
  </div>

  <div class="inline" style="margin-top:8px;">
    <button id="wicketBtn" class="danger">Wicket</button>
    <button id="wideBtn" class="secondary">Wide</button>
    <button id="noballBtn" class="secondary">No-ball</button>
    <button id="changeStrikerBtn" class="secondary">Change Striker</button>
    <button id="resetBtn" style="background:#444;">Reset</button>
  </div>

  <div style="margin-top:10px;">
    <label>Extras quick-select:</label>
    <select id="extraQuickSelect">
      <option value="0">0</option><option value="1">1</option>
      <option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="6">6</option>
    </select>
  </div>

  <div style="margin-top:10px;">
    <label>Current Bowler: <span id="currentBowlerName">N/A</span></label>
    <select id="currentBowlerSelect"></select>
  </div>

  <!-- NEW: Current batsman (striker) display -->
  <div style="margin-top:10px;">
    <label>Current Batsman (Striker): <span id="currentBatsmanName">N/A</span></label>
  </div>
</div>

<!-- TABLES -->
<div class="card grid">
  <div>
    <h4>Batsmen</h4>
    <table id="batsmenTable">
      <thead><tr><th>Name</th><th>R</th><th>B</th><th>4s</th><th>6s</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h4>Bowlers</h4>
    <table id="bowlersTable">
      <thead><tr><th>Name</th><th>O</th><th>R</th><th>W</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<h4>Match Log</h4>
<div class="log" id="logBox"></div>

<!-- SCRIPT -->
<script>
/* --------------------------------------------------
   PLAYER LIST FROM EXTERNAL FILE
-------------------------------------------------- */
let FIXED_PLAYERS = [];
let SORTED_PLAYERS = [];
let playersLoaded = false;

async function loadPlayers() {
  try {
    const res = await fetch("/players.json");
    if (!res.ok) throw new Error("players.json not found");
    const data = await res.json();
    if (!data || !Array.isArray(data.players) || data.players.length === 0) {
      throw new Error("Invalid players.json format");
    }
    FIXED_PLAYERS = data.players;
  } catch (e) {
    console.error("Failed to load players.json, using default list", e);
    FIXED_PLAYERS = [
      "Rohit Sharma","Virat Kohli","KL Rahul","Hardik Pandya","Ravindra Jadeja",
      "Jasprit Bumrah","Shubman Gill","Suryakumar Yadav","Ishan Kishan",
      "Mohammed Shami","Washington Sundar","Shardul Thakur"
    ];
  }
  SORTED_PLAYERS = [...FIXED_PLAYERS].sort((a,b)=>
    a.localeCompare(b,undefined,{sensitivity:"base"})
  );
  playersLoaded = true;
  populateInitialDropdowns();
}

/* --------------------------------------------------
   SELECT POPULATION HELPERS
-------------------------------------------------- */
function populateSelectWithDefault(id, players, defaultIndex=null) {
  const sel = document.getElementById(id); if (!sel) return;
  sel.innerHTML="";
  players.forEach((name,idx)=>{
    const opt=document.createElement("option");
    opt.value=name; opt.text=name;
    if (defaultIndex!==null && idx===defaultIndex) opt.selected=true;
    sel.appendChild(opt);
  });
}

function populateSelectNoDefault(id, players) {
  const sel = document.getElementById(id); if (!sel) return;
  sel.innerHTML="";
  const ph=document.createElement("option"); ph.value=""; ph.text="-- Select player --";
  sel.appendChild(ph);
  players.forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.text=name;
    sel.appendChild(opt);
  });
}

/* NEW: stable updater to avoid flicker on frequently-refreshed selects */
function updateSelectIfChanged(id, players, currentValue) {
  const sel = document.getElementById(id);
  if (!sel) return;

  const existing = Array.from(sel.options).map(o => o.value);
  const same = existing.length === players.length &&
               existing.every((v,i) => v === players[i]);

  if (!same) {
    sel.innerHTML = "";
    players.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.text = name;
      sel.appendChild(opt);
    });
  }

  if (currentValue && players.includes(currentValue)) {
    sel.value = currentValue;
  }
}

/* INITIAL POPULATE ‚Äì called after players load */
function populateInitialDropdowns() {
  if (!playersLoaded) return;
  populateSelectWithDefault("strikerSelect", SORTED_PLAYERS, 0);
  populateSelectWithDefault("nonStrikerSelect", SORTED_PLAYERS, 1);
  populateSelectWithDefault("startingBowlerSelect", SORTED_PLAYERS, 2);

  populateSelectNoDefault("newBatsmanSelect", SORTED_PLAYERS);
  populateSelectNoDefault("nextBowlerSelect", SORTED_PLAYERS);
  populateSelectNoDefault("setStrikerSelect", SORTED_PLAYERS);
}

/* OTHER STATE */
let bowlerPopupAlreadyShown = false;
let currentExtraType = null;
let lastOverBallsPrompted = null;

/* --------------------------------------------------
   API helper
-------------------------------------------------- */
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  const text = await res.text().catch(()=>null);
  let parsed = null;
  try { parsed = text ? JSON.parse(text) : null; }
  catch(e) { parsed = text; }

  if (!res.ok) {
    const msg = parsed?.message || parsed || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return parsed;
}

/* --------------------------------------------------
   CREATE TEAMS
-------------------------------------------------- */
document.getElementById("createTeamsBtn").addEventListener("click", async ()=>{
  await api("/api/createTeams", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      teamA:{name:document.getElementById("teamA_name").value},
      teamB:{name:document.getElementById("teamB_name").value}
    })
  });
  document.getElementById("inningsStartBlock").style.display="block";
  alert("Teams saved. Ready to start innings.");
});

/* --------------------------------------------------
   START INNINGS
-------------------------------------------------- */
document.getElementById("startInningsBtn").addEventListener("click", async ()=>{
  const battingTeam=document.getElementById("battingTeamSelect").value;
  const openingStriker=document.getElementById("strikerSelect").value;
  const openingNonStriker=document.getElementById("nonStrikerSelect").value;
  const startingBowler=document.getElementById("startingBowlerSelect").value;

  if (!openingStriker || !openingNonStriker || !startingBowler)
    return alert("Choose openers and bowler");
  if (openingStriker===openingNonStriker)
    return alert("Striker & non-striker must be different");

  await api("/api/setTeamsAndMatch", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ battingTeam, openingStriker, openingNonStriker, startingBowler })
  });

  refresh();
});

/* --------------------------------------------------
   END INNINGS
-------------------------------------------------- */
document.getElementById("endInningsBtn").addEventListener("click", async ()=>{
  if (!confirm("End 1st innings?")) return;
  await api("/api/endInnings", { method:"POST" });
  refresh();
});

/* NEW: end-innings popup buttons */
document.getElementById("confirmEndInningsBtn").addEventListener("click", async ()=>{
  try {
    await api("/api/endInnings", { method:"POST" });
  } catch (e) {
    alert(e.message);
  }
  document.getElementById("overEndPopup").style.display="none";
  lastOverBallsPrompted = null;
  refresh();
});

document.getElementById("continueInningsBtn").addEventListener("click", ()=>{
  document.getElementById("overEndPopup").style.display="none";
});

/* --------------------------------------------------
   RUN BUTTONS
-------------------------------------------------- */
document.querySelectorAll(".runBtn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    try {
      await api(`/api/run/${btn.dataset.runs}`, { method:"POST" });
      refresh();
    } catch(err){ alert(err.message); }
  });
});

/* --------------------------------------------------
   WICKET FLOW
-------------------------------------------------- */
document.getElementById("wicketBtn").addEventListener("click", ()=>{
  document.getElementById("wicketTypePopup").style.display="flex";
});

document.getElementById("cancelWicketTypeBtn").addEventListener("click", ()=>{
  document.getElementById("wicketTypePopup").style.display="none";
});

document.getElementById("confirmWicketTypeBtn").addEventListener("click", async ()=>{
  const type=document.getElementById("wicketTypeSelect").value;
  document.getElementById("wicketTypePopup").style.display="none";

  try {
    const data=await api("/api/wicket", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ wicketType:type })
    });
    if (data.awaitingNewBatsman)
      document.getElementById("wicketPopup").style.display="flex";
    refresh();
  } catch(err){ alert(err.message); }
});

/* POPUP after wicket */
document.getElementById("openNewBatsmanBtn").addEventListener("click", async ()=>{
  document.getElementById("wicketPopup").style.display="none";
  await populateNewBatsmanOptions();
  document.getElementById("newBatsmanPopup").style.display="flex";
});

document.getElementById("activateLastManBtn").addEventListener("click", async ()=>{
  await api("/api/lastManStanding", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ useLastMan:true })
  });
  document.getElementById("wicketPopup").style.display="none";
  refresh();
});

document.getElementById("closeWicketPopupBtn").addEventListener("click", ()=>{
  document.getElementById("wicketPopup").style.display="none";
});

/* New batsman */
document.getElementById("closeNewBatsmanBtn").addEventListener("click", ()=>{
  document.getElementById("newBatsmanPopup").style.display="none";
});

document.getElementById("submitNewBatsmanBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("newBatsmanSelect").value;
  if (!name) return alert("Select batsman");
  await api("/api/newBatsman", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ name })
  });
  document.getElementById("newBatsmanPopup").style.display="none";
  refresh();
});

/* AVAILABLE BATSMEN */
async function populateNewBatsmanOptions(){
  try {
    const data=await api("/api/score");
    const outNames=data.players.filter(p=>p.out).map(p=>p.name);
    const available=SORTED_PLAYERS.filter(n =>
      !outNames.includes(n) && n!==data.nonStriker && n!==data.striker
    );
    populateSelectNoDefault("newBatsmanSelect", available.length ? available : SORTED_PLAYERS);
  } catch(err) {
    populateSelectNoDefault("newBatsmanSelect", SORTED_PLAYERS);
  }
}

/* --------------------------------------------------
   EXTRAS POPUP
-------------------------------------------------- */
document.getElementById("wideBtn").addEventListener("click", ()=> openExtraPopup("wide"));
document.getElementById("noballBtn").addEventListener("click", ()=> openExtraPopup("noball"));

function openExtraPopup(type){
  currentExtraType=type;
  document.getElementById("extraRunsInput").value=document.getElementById("extraQuickSelect").value || "0";
  document.getElementById("extraPopup").style.display="flex";
}

document.getElementById("cancelExtraBtn").addEventListener("click", ()=>{
  document.getElementById("extraPopup").style.display="none";
  currentExtraType=null;
});

document.getElementById("submitExtraBtn").addEventListener("click", async ()=>{
  const extra=parseInt(document.getElementById("extraRunsInput").value)||0;
  try {
    await api("/api/extras",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ type:currentExtraType, extraRuns:extra })
    });
    document.getElementById("extraPopup").style.display="none";
    currentExtraType=null;
    refresh();
  } catch(err){ alert(err.message); }
});

/* --------------------------------------------------
   CHANGE BOWLER
-------------------------------------------------- */
document.getElementById("currentBowlerSelect").addEventListener("change", async ()=>{
  const bowler=document.getElementById("currentBowlerSelect").value;
  if (!bowler) return;
  await api("/api/selectBowler",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ bowler })
  });
  refresh();
});

/* Next bowler popup */
document.getElementById("confirmNextBowlerBtn").addEventListener("click", async ()=>{
  const bowler=document.getElementById("nextBowlerSelect").value;
  if (!bowler) return alert("Choose bowler");
  try {
    const res=await api("/api/selectBowler",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ bowler })
    });

    if (res.warningSame) {
      const warn=document.getElementById("bowlerWarning");
      warn.innerText="Warning: same bowler as last over";
      warn.style.display="block";
      setTimeout(()=>warn.style.display="none", 1200);
    }
    document.getElementById("bowlerPopup").style.display="none";
    bowlerPopupAlreadyShown=false;
    refresh();
  } catch(err) {
    alert(err.message);
  }
});

document.getElementById("cancelBowlerBtn").addEventListener("click", ()=>{
  document.getElementById("bowlerPopup").style.display="none";
  bowlerPopupAlreadyShown=false;
});

/* --------------------------------------------------
   CHANGE STRIKER POPUP
-------------------------------------------------- */
document.getElementById("changeStrikerBtn").addEventListener("click", ()=>{
  document.getElementById("changeStrikerPopup").style.display="flex";
});

document.getElementById("swapStrikeBtn").addEventListener("click", async ()=>{
  try {
    await api("/api/changeStrike",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"swap" })
    });
    document.getElementById("changeStrikerPopup").style.display="none";
    refresh();
  } catch(err){ alert(err.message); }
});

document.getElementById("setStrikerBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("setStrikerSelect").value;
  if (!name) return alert("Choose player");
  try {
    await api("/api/changeStrike",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"set", name })
    });
    document.getElementById("changeStrikerPopup").style.display="none";
    refresh();
  } catch(err){ alert(err.message); }
});

document.getElementById("cancelSetStrikerBtn").addEventListener("click", ()=>{
  document.getElementById("changeStrikerPopup").style.display="none";
});

/* --------------------------------------------------
   RESET
-------------------------------------------------- */
document.getElementById("resetBtn").addEventListener("click", async ()=>{
  if (!confirm("Reset entire match?")) return;
  await api("/api/reset",{ method:"POST" });
  populateInitialDropdowns();
  document.getElementById("inningsStartBlock").style.display="block";
  refresh();
});

/* --------------------------------------------------
   REFRESH FUNCTION
-------------------------------------------------- */
async function refresh(){
  try {
    const data=await api("/api/score");

    document.getElementById("inningsInfo").innerText=
      `Innings ${data.innings}`;

    document.getElementById("innings1Summary").innerText=
      data.innings1Score.battingTeam
        ? `${data.innings1Score.score}/${data.innings1Score.wickets} in `
          + `${Math.floor(data.innings1Score.balls/6)}.${data.innings1Score.balls%6}`
        : "";

    document.getElementById("teamNames").innerText=
      `${data.battingTeam?data.teams[data.battingTeam].name:""} batting vs ` +
      `${data.bowlingTeam?data.teams[data.bowlingTeam].name:""}`;

    document.getElementById("targetInfo").innerText=
      data.innings===2
        ? `Target: ${data.target} | Need ${Math.max(0,data.target-data.score)}`
        : "";

    document.getElementById("score").innerText=
      `${data.score}/${data.wickets}`;

    document.getElementById("overs").innerText=
      `Overs: ${Math.floor(data.balls/6)}.${data.balls%6}`;

    document.getElementById("endInningsBtn").style.display=
      (data.innings===1 && data.matchStarted) ? "inline-block" : "none";

    /* Batsmen table */
    const batsT=document.querySelector("#batsmenTable tbody"); batsT.innerHTML="";
    data.players.forEach(p=>{
      const tr=document.createElement("tr");
      let mark="";
      if (!p.out && p.name===data.striker) mark=" ‚ö°";
      else if (!p.out && p.name===data.nonStriker) mark=" (ns)";
      else if (p.out) mark=` ‚úñ (${p.outReason||"out"})`;

      tr.innerHTML=`<td>${p.name}${mark}</td>
                    <td>${p.runs}</td><td>${p.ballsFaced}</td>
                    <td>${p.fours}</td><td>${p.sixes}</td>`;
      batsT.appendChild(tr);
    });

    /* Bowlers table */
    const bowlT=document.querySelector("#bowlersTable tbody"); bowlT.innerHTML="";
    data.bowlers.forEach(b=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${b.name}${b.name===data.currentBowler?" üéØ":""}</td>
                    <td>${Math.floor(b.totalBalls/6)}.${b.totalBalls%6}</td>
                    <td>${b.runsConceded}</td>
                    <td>${b.wickets}</td>`;
      bowlT.appendChild(tr);
    });

    /* CURRENT BOWLER SELECT ‚Äì stable (no flicker) */
    const allBowlerNames=[...SORTED_PLAYERS];
    const cur=data.currentBowler || "";
    updateSelectIfChanged("currentBowlerSelect", allBowlerNames, cur);
    document.getElementById("currentBowlerName").innerText = cur || "N/A";

    /* CURRENT BATSMAN DISPLAY */
    document.getElementById("currentBatsmanName").innerText = data.striker || "N/A";

    /* Show next-bowler popup only once per over */
    if (data.awaitingNewBowler && !bowlerPopupAlreadyShown) {
      const list=[...SORTED_PLAYERS];
      populateSelectNoDefault("nextBowlerSelect", list);
      document.getElementById("bowlerWarning").style.display="none";
      document.getElementById("bowlerPopup").style.display="flex";
      bowlerPopupAlreadyShown=true;
    }
    if (!data.awaitingNewBowler) {
      bowlerPopupAlreadyShown=false;
      document.getElementById("bowlerPopup").style.display="none";
    }

    /* Wicket popup if needed */
    if (data.awaitingNewBatsman) {
      document.getElementById("wicketPopup").style.display="flex";
    } else {
      document.getElementById("wicketPopup").style.display="none";
      document.getElementById("newBatsmanPopup").style.display="none";
    }

    /* End-innings popup at end of each over (only innings 1) */
    const completedOver = data.matchStarted &&
                          data.innings === 1 &&
                          data.balls > 0 &&
                          data.balls % 6 === 0;

    if (completedOver && lastOverBallsPrompted !== data.balls) {
      document.getElementById("overEndPopup").style.display = "flex";
      lastOverBallsPrompted = data.balls;
    }

    /* Change Striker list */
    const alive = data.players.filter(p=>!p.out).map(p=>p.name);
    populateSelectNoDefault("setStrikerSelect", alive);

    /* Log */
    document.getElementById("logBox").innerHTML=data.log.join("<br>");
    document.getElementById("logBox").scrollTop=document.getElementById("logBox").scrollHeight;
  }
  catch(err){ console.error("refresh() error:", err); }
}

/* Refresh Loop & player loading */
loadPlayers();
refresh();
setInterval(refresh, 1500);
</script>

</body>
</html>