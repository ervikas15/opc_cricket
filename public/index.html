<!DOCTYPE html>
<html>
<head>
  <title>OPC Cricket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial; padding: 18px; background: #f4f7fc; color:#122; }
    .card { background: white; padding: 14px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.06); margin-bottom: 14px; }
    h1 { text-align: center; margin: 6px 0 14px 0; }
    select, input[type="text"], input[type="number"], textarea {
      width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;
    }
    label { display: block; margin-top: 8px; font-weight: bold; font-size: 14px; }
    button { padding: 8px 12px; margin: 4px; background: #0c7bdc; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button.secondary { background:#eee; color:#222 }
    button.danger { background:#d9534f; }
    .inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:6px; border-bottom:1px solid #f0f0f0; font-size:13px }
    .small { font-size:12px; color:#666 }
    .log { background: #fff; padding: 10px; border-radius: 8px; height: 180px; overflow-y: auto; border: 1px solid #ddd; font-family: monospace; }
    .target-info { font-size: 14px; font-weight: bold; color: #0c7bdc; margin-top: 8px; }

    /* Popups */
    .overlay {
      display:none; position: fixed;
      top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.45);
      justify-content:center; align-items:center; z-index:999;
    }
    .popup {
      background:white; padding:16px; border-radius:10px;
      width:360px; box-shadow:0 8px 30px rgba(0,0,0,0.25);
    }
    .popup .row { display:flex; gap:8px; margin-top:8px; }
    .popup .row button { flex:1; }
    .warning { color: #a66; font-weight:700; margin-top:8px; }
  </style>
</head>
<body>
<h1>Orchid Park Cricket Scoring</h1>

<div id="bowlerPopup" class="overlay">
  <div class="popup">
    <h3>Select next bowler</h3>
    <label>Choose bowler:</label>
    <select id="nextBowlerSelect"></select>
    <div id="bowlerWarning" class="warning" style="display:none;"></div>
    <div class="row" style="margin-top:10px;">
      <button id="confirmNextBowlerBtn">Set Bowler & Resume</button>
      <button id="cancelBowlerBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
    <hr style="margin:10px 0; border:0; border-top:1px solid #eee;" id="bowlerPopupEndInningsHr" style="display:none;">
    <div id="bowlerPopupEndInningsBlock" style="display:none;">
      <p class="small" style="margin-top:10px;">Or end innings now:</p>
      <button id="bowlerPopupEndInningsBtn" class="danger" style="width:100%;">END 1ST INNINGS</button>
    </div>
  </div>
</div>

<div id="extraPopup" class="overlay">
  <div class="popup">
    <h3>Extras</h3>
    <label id="extraLabel">Extra runs (besides +1):</label>
    <input id="extraRunsInput" type="number" min="0" value="0" />
    <div class="row" style="margin-top:10px;">
      <button id="submitExtraBtn">Submit</button>
      <button id="cancelExtraBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<div id="wicketTypePopup" class="overlay">
  <div class="popup">
    <h3>Wicket ‚Äî Choose type</h3>
    <label>Type:</label>
    <select id="wicketTypeSelect">
      <option value="Bowled">Bowled</option>
      <option value="Caught">Caught</option>
      <option value="LBW">LBW</option>
      <option value="Run Out">Run Out</option>
      <option value="Stumped">Stumped</option>
      <option value="Hit Wicket">Hit Wicket</option>
      <option value="Retired Hurt">Retired Hurt</option>
      <option value="Out of the Court">Out of the Court</option>
      <option value="Other">Other</option>
    </select>
    <div class="row" style="margin-top:10px;">
      <button id="confirmWicketTypeBtn">Confirm Wicket</button>
      <button id="cancelWicketTypeBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<div id="wicketPopup" class="overlay">
  <div class="popup">
    <h3>Wicket! Choose action</h3>
    <div class="row">
      <button id="openNewBatsmanBtn">Select New Batsman</button>
      <button id="activateLastManBtn">Last Man Standing</button>
    </div>
    <div class="row">
      <button id="closeWicketPopupBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<div id="newBatsmanPopup" class="overlay">
  <div class="popup">
    <h3>Select New Batsman</h3>
    <select id="newBatsmanSelect"></select>
    <div class="row" style="margin-top:10px;">
      <button id="submitNewBatsmanBtn">Add</button>
      <button id="closeNewBatsmanBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="changeStrikerPopup">
  <div class="popup">
    <h3>Change Striker (Advanced)</h3>

    <div class="row">
      <button id="swapStrikeBtn">Swap Striker & Non-Striker</button>
    </div>

    <label style="margin-top:8px;">Or set a specific player as striker (Only non-out players listed):</label>
    <select id="setStrikerSelect"></select>

    <div class="row" style="margin-top:10px;">
      <button id="setStrikerBtn">Set Striker</button>
      <button id="cancelSetStrikerBtn" style="background:#ddd;color:#222">Cancel</button>
    </div>
  </div>
</div>

<div id="matchEndPopup" class="overlay">
  <div class="popup">
    <h3 id="matchEndHeader">Match Ended!</h3>
    <p id="matchEndResult" style="font-size:18px; font-weight:bold; margin:10px 0; color:#0c7bdc; text-align:center;"></p>
    <div class="row" style="margin-top:20px;">
      <button id="startNewMatchBtn" style="width:100%;">Start New Match</button>
    </div>
  </div>
</div>

<div class="card" id="matchSetupCard">
  <h3>üèè Match Setup</h3>
  <h4>1. Create Teams</h4>
  <div class="grid">
    <div><label>Team A Name:</label><input id="teamA_name" value="Mandai Monks"></div>
    <div><label>Team B Name:</label><input id="teamB_name" value="Seletar Sharks"></div>
  </div>
  <button id="createTeamsBtn" style="margin-top:10px;width:100%;">SAVE TEAMS</button>
  <hr style="margin:15px 0;" />
  <div id="inningsStartBlock" style="display:none;">
    <h4>2. Start Innings <span id="inningsStartHeader">1</span></h4>
    <label>Batting Team:</label>
    <select id="battingTeamSelect"><option value="teamA">Team A</option><option value="teamB">Team B</option></select>

    <div class="grid" style="margin-top:10px;">
      <div><label>Opening Striker:</label><select id="strikerSelect"></select></div>
      <div><label>Opening Non-Striker:</label><select id="nonStrikerSelect"></select></div>
    </div>

    <label style="margin-top:10px;">Opening Bowler:</label>
    <select id="startingBowlerSelect"></select>

    <div style="margin-top:10px;"><button id="startInningsBtn" style="width:100%;">START INNINGS</button></div>
  </div>
</div>

<div class="card">
  <h3>üìä Scoreboard</h3>
  <div id="inningsInfo" style="font-size:16px;font-weight:700;color:#0c7bdc;">Innings 1</div>
  <div id="innings1Summary" class="small" style="margin-bottom:6px;"></div>
  <div id="teamNames" style="font-size:14px;color:#444;"></div>
  <div id="targetInfo" class="target-info"></div>
  <div id="score" style="font-size:36px;font-weight:700">0/0</div>
  <div id="overs" class="small">Overs: 0.0</div>
  <div style="margin-top:10px;">
    <button id="endInningsBtn" class="danger" style="display:none;">END 1ST INNINGS</button>
  </div>
</div>

<div class="card">
  <h3>‚ñ∂Ô∏è Scoring Controls</h3>

  <div class="inline">
    <button class="runBtn" data-runs="0">0</button>
    <button class="runBtn" data-runs="1">1</button>
    <button class="runBtn" data-runs="2">2</button>
    <button class="runBtn" data-runs="3">3</button>
    <button class="runBtn" data-runs="4">4</button>
    <button class="runBtn" data-runs="5">5</button>
    <button class="runBtn" data-runs="6">6</button>
  </div>

  <div class="inline" style="margin-top:8px;">
    <button id="wicketBtn" class="danger">Wicket</button>
    <button id="wideBtn" class="secondary">Wide</button>
    <button id="noballBtn" class="secondary">No-ball</button>
    <button id="changeStrikerBtn" class="secondary">Change Striker (Adv.)</button>
    <button id="resetBtn" style="background:#444;">Reset</button>
  </div>

  <div style="margin-top:10px;">
    <label>Extras quick-select:</label>
    <select id="extraQuickSelect">
      <option value="0">0</option><option value="1">1</option>
      <option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="6">6</option>
    </select>
  </div>

  <div style="margin-top:10px;">
    <label>Current Bowler: <span id="currentBowlerName">N/A</span></label>
    <select id="currentBowlerSelect"></select>
  </div>

  <div style="margin-top:10px;">
    <label>Current Batsman (Striker):</label>
    <select id="currentStrikerSelect"></select>
  </div>
  
  <div style="margin-top:10px;">
    <label>Current Batsman (Non-Striker):</label>
    <select id="currentNonStrikerSelect"></select>
  </div>
</div>

<div class="card grid">
  <div>
    <h4>Batsmen</h4>
    <table id="batsmenTable">
      <thead><tr><th>Name</th><th>R</th><th>B</th><th>4s</th><th>6s</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div>
    <h4>Bowlers</h4>
    <table id="bowlersTable">
      <thead><tr><th>Name</th><th>O</th><th>R</th><th>W</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<h4>Match Log</h4>
<div class="log" id="logBox"></div>

<script>
/* --------------------------------------------------
   PLAYER LIST FROM EXTERNAL FILE
-------------------------------------------------- */
let FIXED_PLAYERS = [];
let SORTED_PLAYERS = [];
let playersLoaded = false;

async function loadPlayers() {
  try {
    const res = await fetch("/players.json");
    if (!res.ok) throw new Error("players.json not found");
    const data = await res.json();
    if (!data || !Array.isArray(data.players) || data.players.length === 0) {
      throw new Error("Invalid players.json format");
    }
    FIXED_PLAYERS = data.players;
  } catch (e) {
    console.error("Failed to load players.json, using default list", e);
    FIXED_PLAYERS = [
      "Rohit Sharma","Virat Kohli","KL Rahul","Hardik Pandya","Ravindra Jadeja",
      "Jasprit Bumrah","Shubman Gill","Suryakumar Yadav","Ishan Kishan",
      "Mohammed Shami","Washington Sundar","Shardul Thakur"
    ];
  }
  SORTED_PLAYERS = [...FIXED_PLAYERS].sort((a,b)=>
    a.localeCompare(b,undefined,{sensitivity:"base"})
  );
  playersLoaded = true;
  populateInitialDropdowns();
}

/* --------------------------------------------------
   SELECT POPULATION HELPERS
-------------------------------------------------- */
function populateSelectWithDefault(id, players, defaultIndex=null) {
  const sel = document.getElementById(id); if (!sel) return;
  sel.innerHTML="";
  players.forEach((name,idx)=>{
    const opt=document.createElement("option");
    opt.value=name; opt.text=name;
    if (defaultIndex!==null && idx===defaultIndex) opt.selected=true;
    sel.appendChild(opt);
  });
}

function populateSelectNoDefault(id, players) {
  const sel = document.getElementById(id); if (!sel) return;
  sel.innerHTML="";
  const ph=document.createElement("option"); ph.value=""; ph.text="-- Select player --";
  sel.appendChild(ph);
  players.forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.text=name;
    sel.appendChild(opt);
  });
}

/* NEW: stable updater to avoid flicker on frequently-refreshed selects */
function updateSelectIfChanged(id, players, currentValue) {
  const sel = document.getElementById(id);
  if (!sel) return;

  const existing = Array.from(sel.options).map(o => o.value);
  
  // Exclude the placeholder from comparison
  const existingValues = existing.filter(v => v !== "");
  const playersToAdd = currentValue ? players : ["", ...players]; // Add placeholder if no current value
  
  const same = existingValues.length === players.length &&
               existingValues.every((v,i) => v === players[i]);

  if (!same || (currentValue && sel.value !== currentValue)) {
    sel.innerHTML = "";
    playersToAdd.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.text = name || "-- Select player --";
      sel.appendChild(opt);
    });
  }

  if (currentValue) {
    sel.value = currentValue;
  } else if (!sel.value) {
    // If no current value, ensure the placeholder is selected
    sel.value = "";
  }
}


/* INITIAL POPULATE ‚Äì called after players load */
function populateInitialDropdowns() {
  if (!playersLoaded) return;
  populateSelectWithDefault("strikerSelect", SORTED_PLAYERS, 0);
  populateSelectWithDefault("nonStrikerSelect", SORTED_PLAYERS, 1);
  populateSelectWithDefault("startingBowlerSelect", SORTED_PLAYERS, 2);

  populateSelectNoDefault("newBatsmanSelect", SORTED_PLAYERS);
  populateSelectNoDefault("nextBowlerSelect", SORTED_PLAYERS);
  populateSelectNoDefault("setStrikerSelect", SORTED_PLAYERS);
  
  // New striker/non-striker selects are populated in refresh()
}

/* OTHER STATE */
let bowlerPopupAlreadyShown = false;
let matchEndPopupShown = false; // NEW state tracker
let currentExtraType = null;

/* --------------------------------------------------
   API helper
-------------------------------------------------- */
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  const text = await res.text().catch(()=>null);
  let parsed = null;
  try { parsed = text ? JSON.parse(text) : null; }
  catch(e) { parsed = text; }

  if (!res.ok) {
    const msg = parsed?.message || parsed || `HTTP ${res.status}`;
    throw new Error(msg);
  }
  return parsed;
}

/* --------------------------------------------------
   CREATE TEAMS
-------------------------------------------------- */
document.getElementById("createTeamsBtn").addEventListener("click", async ()=>{
  await api("/api/createTeams", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      teamA:{name:document.getElementById("teamA_name").value},
      teamB:{name:document.getElementById("teamB_name").value}
    })
  });
  document.getElementById("inningsStartBlock").style.display="block";
  alert("Teams saved. Ready to start innings.");
});

/* --------------------------------------------------
   START INNINGS
-------------------------------------------------- */
document.getElementById("startInningsBtn").addEventListener("click", async ()=>{
  const battingTeam=document.getElementById("battingTeamSelect").value;
  const openingStriker=document.getElementById("strikerSelect").value;
  const openingNonStriker=document.getElementById("nonStrikerSelect").value;
  const startingBowler=document.getElementById("startingBowlerSelect").value;

  if (!openingStriker || !openingNonStriker || !startingBowler)
    return alert("Choose openers and bowler");
  if (openingStriker===openingNonStriker)
    return alert("Striker & non-striker must be different");

  await api("/api/setTeamsAndMatch", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ battingTeam, openingStriker, openingNonStriker, startingBowler })
  });

  refresh();
});

/* --------------------------------------------------
   END INNINGS (Main Button)
-------------------------------------------------- */
document.getElementById("endInningsBtn").addEventListener("click", async ()=>{
  if (!confirm("End 1st innings?")) return;
  await api("/api/endInnings", { method:"POST" });
  refresh();
});

/* NEW: End Innings from Bowler Popup */
document.getElementById("bowlerPopupEndInningsBtn").addEventListener("click", async ()=>{
  try {
    if (!confirm("Confirm: End 1st innings now?")) return; // Added confirmation
    await api("/api/endInnings", { method:"POST" });
  } catch (e) {
    alert(e.message);
  }
  document.getElementById("bowlerPopup").style.display="none";
  bowlerPopupAlreadyShown=false;
  refresh();
});

/* --------------------------------------------------
   RUN BUTTONS
-------------------------------------------------- */
document.querySelectorAll(".runBtn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    try {
      await api(`/api/run/${btn.dataset.runs}`, { method:"POST" });
      refresh();
    } catch(err){ alert(err.message); }
  });
});

/* --------------------------------------------------
   EXTRAS POPUP
-------------------------------------------------- */
document.getElementById("wideBtn").addEventListener("click", ()=> openExtraPopup("wide"));
document.getElementById("noballBtn").addEventListener("click", ()=> openExtraPopup("noball"));

function openExtraPopup(type){
  currentExtraType=type;
  document.getElementById("extraRunsInput").value=document.getElementById("extraQuickSelect").value || "0";
  document.getElementById("extraPopup").style.display="flex";
}

document.getElementById("cancelExtraBtn").addEventListener("click", ()=>{
  document.getElementById("extraPopup").style.display="none";
  currentExtraType=null;
});

document.getElementById("submitExtraBtn").addEventListener("click", async ()=>{
  const extra=parseInt(document.getElementById("extraRunsInput").value)||0;
  try {
    await api("/api/extras",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ type:currentExtraType, extraRuns:extra })
    });
    document.getElementById("extraPopup").style.display="none";
    currentExtraType=null;
    refresh();
  } catch(err){ alert(err.message); }
});

/* --------------------------------------------------
   WICKET FLOW
-------------------------------------------------- */
document.getElementById("wicketBtn").addEventListener("click", ()=>{
  document.getElementById("wicketTypePopup").style.display="flex";
});

document.getElementById("cancelWicketTypeBtn").addEventListener("click", ()=>{
  document.getElementById("wicketTypePopup").style.display="none";
});

document.getElementById("confirmWicketTypeBtn").addEventListener("click", async ()=>{
  const type=document.getElementById("wicketTypeSelect").value;
  document.getElementById("wicketTypePopup").style.display="none";

  try {
    const data=await api("/api/wicket", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ wicketType:type })
    });
    // Only show wicket popup if the match is still active and awaiting new batsman
    if (data.awaitingNewBatsman && data.state.matchStarted)
      document.getElementById("wicketPopup").style.display="flex";
    refresh();
  } catch(err){ alert(err.message); }
});

/* POPUP after wicket */
document.getElementById("openNewBatsmanBtn").addEventListener("click", async ()=>{
  document.getElementById("wicketPopup").style.display="none";
  await populateNewBatsmanOptions();
  document.getElementById("newBatsmanPopup").style.display="flex";
});

document.getElementById("activateLastManBtn").addEventListener("click", async ()=>{
  await api("/api/lastManStanding", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ useLastMan:true })
  });
  document.getElementById("wicketPopup").style.display="none";
  refresh();
});

document.getElementById("closeWicketPopupBtn").addEventListener("click", ()=>{
  document.getElementById("wicketPopup").style.display="none";
});

/* New batsman */
document.getElementById("closeNewBatsmanBtn").addEventListener("click", ()=>{
  document.getElementById("newBatsmanPopup").style.display="none";
});

document.getElementById("submitNewBatsmanBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("newBatsmanSelect").value;
  if (!name) return alert("Select batsman");
  await api("/api/newBatsman", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ name })
  });
  document.getElementById("newBatsmanPopup").style.display="none";
  refresh();
});

/* AVAILABLE BATSMEN */
async function populateNewBatsmanOptions(){
  try {
    const data=await api("/api/score");
    const outNames=data.players.filter(p=>p.out).map(p=>p.name);
    // Include current striker/non-striker as they are only removed on death, this is a safer check
    const battingPlayers = [data.striker, data.nonStriker].filter(Boolean); 
    const available=SORTED_PLAYERS.filter(n =>
      !outNames.includes(n) && !battingPlayers.includes(n)
    );
    populateSelectNoDefault("newBatsmanSelect", available.length ? available : SORTED_PLAYERS);
  } catch(err) {
    populateSelectNoDefault("newBatsmanSelect", SORTED_PLAYERS);
  }
}

/* --------------------------------------------------
   CHANGE BOWLER
-------------------------------------------------- */
document.getElementById("currentBowlerSelect").addEventListener("change", async (e)=>{
  const bowler=e.target.value;
  if (!bowler) return;
  try {
      await api("/api/selectBowler",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ bowler })
      });
      refresh();
  } catch(err) {
      alert(err.message);
      // Revert select value on error
      const data=await api("/api/score");
      document.getElementById("currentBowlerSelect").value = data.currentBowler || "";
  }
});

/* Next bowler popup */
document.getElementById("confirmNextBowlerBtn").addEventListener("click", async ()=>{
  const bowler=document.getElementById("nextBowlerSelect").value;
  if (!bowler) return alert("Choose bowler");
  try {
    const res=await api("/api/selectBowler",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ bowler })
    });

    if (res.warningSame) {
      const warn=document.getElementById("bowlerWarning");
      warn.innerText="Warning: same bowler as last over";
      warn.style.display="block";
      setTimeout(()=>warn.style.display="none", 1200);
    }
    document.getElementById("bowlerPopup").style.display="none";
    bowlerPopupAlreadyShown=false;
    refresh();
  } catch(err) {
    alert(err.message);
  }
});

document.getElementById("cancelBowlerBtn").addEventListener("click", ()=>{
  document.getElementById("bowlerPopup").style.display="none";
  bowlerPopupAlreadyShown=false;
});

/* --------------------------------------------------
   CHANGE STRIKE (Main Selects & Popup)
-------------------------------------------------- */
// MODIFIED: Main striker select event listener to use set_striker
document.getElementById("currentStrikerSelect").addEventListener("change", async (e)=>{
  const name=e.target.value;
  if (!name) return;
  try {
      await api("/api/changeStrike",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        // UPDATED: action changed from "set" to "set_striker"
        body:JSON.stringify({ action:"set_striker", name }) 
      });
      refresh();
  } catch(err) {
      // Suppress the disruptive alert() but log the error 
      console.error(`Failed to set striker to ${name}. Backend check failed.`, err.message);
      
      // Revert select value by forcing a refresh, which re-reads the correct striker from the backend
      refresh(); 
  }
});

// NEW: Non-Striker Select (Main Select)
document.getElementById("currentNonStrikerSelect").addEventListener("change", async (e)=>{
    const name=e.target.value;
    if (!name) return;
    try {
        await api("/api/changeStrike",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({ action:"set_non_striker", name }) 
        });
        refresh();
    } catch(err) {
        console.error(`Failed to set non-striker to ${name}. Backend check failed.`, err.message);
        alert(err.message); 
        refresh(); 
    }
});


// Popup
document.getElementById("changeStrikerBtn").addEventListener("click", ()=>{
  document.getElementById("changeStrikerPopup").style.display="flex";
});

document.getElementById("swapStrikeBtn").addEventListener("click", async ()=>{
  try {
    await api("/api/changeStrike",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ action:"swap" })
    });
    document.getElementById("changeStrikerPopup").style.display="none";
    refresh();
  } catch(err){ alert(err.message); }
});

document.getElementById("setStrikerBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("setStrikerSelect").value;
  if (!name) return alert("Choose player");
  try {
    await api("/api/changeStrike",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      // UPDATED: action changed from "set" to "set_striker"
      body:JSON.stringify({ action:"set_striker", name })
    });
    document.getElementById("changeStrikerPopup").style.display="none";
    refresh();
  } catch(err){ alert(err.message); }
});

document.getElementById("cancelSetStrikerBtn").addEventListener("click", ()=>{
  document.getElementById("changeStrikerPopup").style.display="none";
});

/* --------------------------------------------------
   RESET & NEW MATCH
-------------------------------------------------- */
async function resetMatch() {
  if (!confirm("Reset entire match?")) return;
  await api("/api/reset",{ method:"POST" });
  populateInitialDropdowns();
  document.getElementById("inningsStartBlock").style.display="block";
  matchEndPopupShown = false; // Reset flag
  document.getElementById("matchEndPopup").style.display="none";
  refresh();
}

document.getElementById("resetBtn").addEventListener("click", resetMatch);

document.getElementById("startNewMatchBtn").addEventListener("click", resetMatch);

/* --------------------------------------------------
   REFRESH FUNCTION
-------------------------------------------------- */
async function refresh(){
  try {
    const data=await api("/api/score");
    const isMatchEnded = !data.matchStarted && (data.innings === 2 || data.finalResult);
    
    // --- Update Scoreboard ---
    document.getElementById("inningsInfo").innerText=
      (isMatchEnded && data.finalResult) ? "MATCH ENDED" : `Innings ${data.innings}`;

    document.getElementById("innings1Summary").innerText=
      data.innings1Score.battingTeam
        ? `${data.innings1Score.score}/${data.innings1Score.wickets} in `
          + `${Math.floor(data.innings1Score.balls/6)}.${data.innings1Score.balls%6}`
        : "";

    document.getElementById("teamNames").innerText=
      `${data.battingTeam?data.teams[data.battingTeam].name:""} batting vs ` +
      `${data.bowlingTeam?data.teams[data.bowlingTeam].name:""}`;

    if (data.target > 0) {
      document.getElementById("targetInfo").innerText=
        data.finalResult // Show final result if present (from server)
          ? data.finalResult
          : data.innings===2
            ? `Target: ${data.target} | Need ${Math.max(0,data.target-data.score)}`
            : "";
    } else {
      document.getElementById("targetInfo").innerText = "";
    }


    document.getElementById("score").innerText=
      `${data.score}/${data.wickets}`;

    document.getElementById("overs").innerText=
      `Overs: ${Math.floor(data.balls/6)}.${data.balls%6}`;

    // Show the main 'End Innings' button ONLY for Innings 1 and when scoring is active
    document.getElementById("endInningsBtn").style.display=
      (data.innings===1 && data.matchStarted && !data.awaitingNewBowler) ? "inline-block" : "none";

    
    // --- Control Visibility based on Match State ---
    const controlsContainer = document.querySelector(".card:nth-child(4)");
    if (controlsContainer) {
      // Hide controls if match has ended 
      controlsContainer.style.display = isMatchEnded ? 'none' : 'block';
    }
    
    // Show setup only when match is NOT started 
    if (data.matchStarted) { 
      document.getElementById("matchSetupCard").style.display = 'none';
    } else {
      document.getElementById("matchSetupCard").style.display = 'block';
      document.getElementById("inningsStartHeader").innerText = data.innings;
    }


    /* Batsmen table */
    const batsT=document.querySelector("#batsmenTable tbody"); batsT.innerHTML="";
    data.players.forEach(p=>{
      const tr=document.createElement("tr");
      let mark="";
      if (!p.out && p.name===data.striker) mark=" ‚ö°";
      else if (!p.out && p.name===data.nonStriker) mark=" (ns)";
      else if (p.out) mark=` ‚úñ (${p.outReason||"out"})`;

      tr.innerHTML=`<td>${p.name}${mark}</td>
                    <td>${p.runs}</td><td>${p.ballsFaced}</td>
                    <td>${p.fours}</td><td>${p.sixes}</td>`;
      batsT.appendChild(tr);
    });

    /* Bowlers table */
    const bowlT=document.querySelector("#bowlersTable tbody"); bowlT.innerHTML="";
    data.bowlers.forEach(b=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${b.name}${b.name===data.currentBowler?" üéØ":""}</td>
                    <td>${Math.floor(b.totalBalls/6)}.${b.totalBalls%6}</td>
                    <td>${b.runsConceded}</td>
                    <td>${b.wickets}</td>`;
      bowlT.appendChild(tr);
    });

    /* CURRENT BOWLER SELECT ‚Äì stable (no flicker) */
    const allBowlerNames=[...SORTED_PLAYERS];
    const curBowler=data.currentBowler || "";
    updateSelectIfChanged("currentBowlerSelect", allBowlerNames, curBowler);
    document.getElementById("currentBowlerName").innerText = curBowler || "N/A";

    // Prepare list of available players (not out)
    const availablePlayers = SORTED_PLAYERS.filter(name => 
        !data.players.find(p => p.name === name && p.out)
    );

    /* CURRENT STRIKER SELECT */
    const curStriker = data.striker || "";
    // Striker list excludes non-striker (in non-LMS mode)
    const availableStrikers = data.lastManStandingMode 
        ? availablePlayers 
        : availablePlayers.filter(name => name !== data.nonStriker);
    updateSelectIfChanged("currentStrikerSelect", availableStrikers, curStriker);

    /* NEW: CURRENT NON-STRIKER SELECT */
    const curNonStriker = data.nonStriker || "";
    // Non-Striker list excludes striker and is only visible in non-LMS mode
    const availableNonStrikers = data.lastManStandingMode 
        ? [] 
        : availablePlayers.filter(name => name !== data.striker);
    
    // Hide/Show non-striker select based on Last Man Standing mode
    document.getElementById("currentNonStrikerSelect").parentElement.style.display = 
        data.lastManStandingMode ? 'none' : 'block';

    updateSelectIfChanged("currentNonStrikerSelect", availableNonStrikers, curNonStriker);


    /* Match End Popup Logic (NEW) */
    if (isMatchEnded && data.finalResult) {
        if (!matchEndPopupShown) {
            document.getElementById("matchEndResult").innerText = data.finalResult;
            document.getElementById("matchEndPopup").style.display = "flex";
            matchEndPopupShown = true;
        }
    } else {
        document.getElementById("matchEndPopup").style.display = "none";
        matchEndPopupShown = false;
    }

    /* Show next-bowler popup only once per over, AND control End Innings option */
    const isOverCompleted = data.awaitingNewBowler;
    const isFirstInnings = data.innings === 1;

    if (isOverCompleted && !bowlerPopupAlreadyShown && !isMatchEnded) {
      const list=[...SORTED_PLAYERS];
      // Filter out current batsmen from bowler selection
      const battingPlayers = [data.striker, data.nonStriker].filter(Boolean);
      const availableBowlers = list.filter(p => !battingPlayers.includes(p));
      
      populateSelectNoDefault("nextBowlerSelect", availableBowlers);
      
      // Control End Innings block visibility
      const endInningsBlock = document.getElementById("bowlerPopupEndInningsBlock");
      const endInningsHr = document.getElementById("bowlerPopupEndInningsHr");
      if (isFirstInnings) {
          endInningsBlock.style.display = "block";
          endInningsHr.style.display = "block";
      } else {
          // Hide for Innings 2 as the match should auto-end
          endInningsBlock.style.display = "none";
          endInningsHr.style.display = "none";
      }

      document.getElementById("bowlerWarning").style.display="none";
      document.getElementById("bowlerPopup").style.display="flex";
      bowlerPopupAlreadyShown=true;
    }
    if (!isOverCompleted || isMatchEnded) {
      bowlerPopupAlreadyShown=false;
      document.getElementById("bowlerPopup").style.display="none";
    }

    /* Wicket popup if needed */
    if (data.awaitingNewBatsman && !isMatchEnded) {
      document.getElementById("wicketPopup").style.display="flex";
    } else {
      document.getElementById("wicketPopup").style.display="none";
      document.getElementById("newBatsmanPopup").style.display="none";
    }

    /* Change Striker list (in popup - still showing only alive players for the 'advanced' view) */
    const alive = data.players.filter(p=>!p.out).map(p=>p.name);
    populateSelectNoDefault("setStrikerSelect", alive);

    /* Log */
    document.getElementById("logBox").innerHTML=data.log.join("<br>");
    document.getElementById("logBox").scrollTop=document.getElementById("logBox").scrollHeight;
  }
  catch(err){ console.error("refresh() error:", err); }
}

/* Refresh Loop & player loading */
loadPlayers();
refresh();
setInterval(refresh, 1500);
</script>

</body>
</html>